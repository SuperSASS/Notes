# æœ‰å…³ Viewport çš„ä¸´æ—¶æ€»ç»“

~~åœ¨Modeä¸­ï¼Œåˆå§‹çš„Viewportå¸ƒå±€ï¼Œä¸`hangingProtocol`å’Œ`viewports`å±æ€§å…±åŒå†³å®šã€‚~~

æš‚æ—¶è®°å½•ï¼š  
æ„Ÿè§‰è·ŸModeé‡Œçš„`viewports`å±æ€§å¹¶ä¸å¤§ï¼Œ  
ä¸»è¦æ˜¯æ ¹æ®`hangingProtocol`å†³å®šçš„ã€å› ä¸ºæœ¬èº«Hanging Protocolä¸­å°±è§„å®šäº†viewportã€‘ã€‚  
è€ŒModeé‡Œçš„`viewports`ï¼Œæˆ‘æ„Ÿè§‰ä¸»è¦æ˜¯æä¾›ä¸SOP Class Handlerçš„ç»‘å®šã€‚

Modeé‡Œå®šä¹‰çš„`viewports`ï¼Œç¬¬ä¸€æ˜¯å‘Šè¯‰è¯¥Modeæ”¯æŒçš„viewportç±»å‹ã€‚  
å¦‚ä¸‹é¢çš„æƒ…å†µï¼š  
![å›¾ 2](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-29_04-16-36.png)  
å½“`hangingProtocol`ä¸ºmpræ—¶ï¼Œä½†`viewports`å®šä¹‰çš„æ˜¯æ˜æ˜¾ä¸ç¬¦çš„PDFçš„ï¼Œ  
åˆ™åŠ è½½çš„æ—¶å€™ä¼šå¼¹çª—æŠ¥é”™å¦‚ä¸‹ï¼š  
![å›¾ 3](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-29_04-17-32.png)  
å†è®¾æ–­ç‚¹(platform/viewer/src/component/ViewportGrid.tsx)ï¼Œå¯çœ‹åˆ°å¦‚ä¸‹æƒ…å†µï¼š  
![å›¾ 4](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-29_04-23-57.png)

é‚£ä¹ˆæƒ…å†µå°±å¤§è‡´æ¸…æ™°äº†ä¸€ä¸‹ï¼š

* `viewports`ï¼šå®šä¹‰è¯¥Mode**æ”¯æŒçš„viewport**ï¼Œä»¥åŠå…¶**å¯¹åº”çš„SOP Handler**ï¼Œæ•…ä¸€èˆ¬ç…§æŠ„ï¼ˆä¸åŒ…å«ä»»ä½•Viewportæœ¬èº«çš„å®šä¹‰ã€å®ç°ï¼‰
* `hangingPotocol`ï¼šå®šä¹‰äº†**åˆå§‹é¡µé¢æ˜¾ç¤ºçš„Viewport**ï¼Œä»¥åŠå„ä¸ªViewportçš„å±æ€§
* `displaySet`ï¼šæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯è½¬æ¢æˆOHIFåçš„ï¼ˆéï¼‰**å½±åƒæ˜¾ç¤ºé›†**
* `sopClassHandlers`ï¼š~~è™½ç„¶æ˜¯æŠŠdisplaySetæ”¾åˆ°hangingPotocolå®šä¹‰çš„viewportä¸Š~~  
  æ„Ÿè§‰ç†è§£æœ‰è¯¯ï¼Œè¿™ä¸ªæ˜¯æŠŠDICOMå…ƒæ•°æ®(Metadata)(æˆ–è¯´DICOM SOP Class)è½¬æ¢ä¸ºDisplaySetçš„ï¼ˆå°±æ˜¯åœ¨å·¦ä¾§å¯ä»¥å±•ç¤ºçš„ä¸œè¥¿ï¼‰  
  å¯¹äºæ¯ä¸ªinstanceçœ‹åˆ°çš„å…ƒæ•°æ®è§ä¸‹å›¾ï¼š  
  ![å›¾ 6](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-31_04-01-45.png)  
  è½¬æ¢ä¸ºdisplaySetï¼ˆè§ä¸‹å›¾ï¼‰  
  ![å›¾ 7](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-31_04-02-09.png)  
  è¿˜å¯ä»¥çœ‹è§ä¸Šé¢æœ‰ä¸ª`SOPClassHandlerId`å±æ€§ï¼Œå°±ä»£è¡¨è¿™ä¸ªDICOMå…ƒæ•°æ®æ˜¯ç”±å“ªä¸ªHandlerç¿»è¯‘è§£é‡Šçš„ã€‚

  å­˜åœ¨æœ‰ç‚¹ä¸æ¸…æ¥šçš„ç‚¹ï¼š
  ![å›¾ 5](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-29_04-28-02.png)  
  è¿™æ˜¯Modeåªå®šä¹‰äº†ä¸€ä¸ªSOP Handlerï¼Œæ‰€ä»¥å›¾ä¸Šåªæœ‰ä¸€ä¸ªï¼›  
  **é—®é¢˜**ï¼šä½†å¦‚æœå®šå¤šä¸ªï¼ŒæŸä¸€å…·ä½“çš„DisplaySetè¯¥æ€ä¹ˆé€‰æ‹©SOP Handlerï¼Ÿ

è¡¥å……ä¸€ä¸ªDebugå¯ä»¥çœ‹çš„ï¼š  
platform/viewer/src/component/ViewportGrid.tsx  
å…¶ä¸­çš„`getViewportPanes()`å°±æ˜¯åœ¨å›¾ç‰‡æ‹–è¿›ï¼ˆåŒå‡»ï¼‰åˆ°viewportæ—¶ï¼Œè·å¾—å„ä¸ªviewportçš„å¯¹åº”å›¾åƒçš„å‡½æ•°ï¼Œå¯åœ¨317è¡Œæ‰“ä¸ªæ–­ç‚¹ã€‚

## æŒ‚ç‰‡åè®®

æŒ‚ç‰‡åè®®æœåŠ¡ä¸­ï¼Œ`protocols`ä¿å­˜äº†ç›®å‰æ‰€æœ‰æ’ä»¶æä¾›çš„åè®®ï¼š
![å›¾ 1](images/5.Viewport%2BHangingProtocol%2BDisplaySet--03-29_04-01-21.png)

éœ€è¦æ˜ç¡®æŒ‚ç‰‡åè®®å¹²å˜›çš„ï¼š

* æ¯ä¸€åˆ‡ç‰‡çš„åŠ è½½ç­–ç•¥
* è§„å®šViewportçš„è‹¥å¹²ç§çŠ¶æ€
  * å¸ƒå±€
  * æ¯ä¸€ä¸ªViewport
    * Idã€Typeã€æ–¹å‘ã€toolGroupIdã€SyncGroups

## éœ€è¦çŸ¥é“æ¸²æŸ“æµç¨‹

### OHIFCornerstoneViewport

ä½¿ç”¨çš„Viewportï¼Œåº”è¯¥éƒ½æ˜¯è¿™ä¸ªã€‚
`extensions\cornerstone\src\Viewport\OHIFCornerstoneViewport.tsx`

Viewportçš„ç±»å‹ï¼š  
![å›¾ 1](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-07_05-02-25.png)  
[ViewportType](https://www.cornerstonejs.org/api/core/namespace/enums/#ORTHOGRAPHIC)

### æµç¨‹

![å›¾ 2](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-07_05-07-28.png)  

å¯¹äº`extensions\cornerstone\src\init.tsx`é‡Œè®¢é˜…çš„`CUSTOM_IMAGE_LOAD_PERFORMED`çš„è§¦å‘æµç¨‹ï¼š  
åœ¨`runImageLoadStrategy()`\[HangingProtocolService.ts] â† `_setVolumeViewport()`\[CornerStoneViewportService.ts] â† `_setDisplaySets()`\[.] â† `setViewportData()`\[.] â† `loadViewportData()`\[OHIFCornerstoneViewport.tsx]

è¡¥å……ï¼š

* `viewportData.datas`æ¥æºäºå®šä¹‰æŒ‚ç‰‡åè®®æ—¶çš„æ¯ä¸ªViewportçš„`displaySets`  
  è€Œ`lutPresentation`åˆ™æ¥æºäº`displaySet`é‡Œçš„`options`  
  ![å›¾ 3](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-07_05-22-11.png)  
  ![å›¾ 4](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-07_05-22-43.png)

## æœ‰å…³3D - MIP

![å›¾ 5](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-07_05-29-40.png)  
å¯¹åº”Cornerstoneçš„MAXIMUM_INTENSITY_BLEND

### ç©¶æçš„ - è¿›å…¥Modeå - ä»åŠ è½½å½±åƒåˆ°æŒ‚ç‰‡åˆ°Viewportçš„æµç¨‹

![å›¾ 6](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-10_01-38-22.png)

1. é¦–å…ˆä»DICOM WebæœåŠ¡å™¨è¯»å–è¯¥Studyçš„æ‰€æœ‰çš„Series
2. åŠ è½½å®Œæˆåï¼Œå¯¹displaySetæœåŠ¡è°ƒç”¨`makeDisplaySets`å‡½æ•°  
   åœ¨å†…éƒ¨çš„æ•ˆæœï¼šå¯¹äºæ¯ä¸€ä¸ªSeriesï¼Œæ ¹æ®Modeé‡Œçš„`sopClassHandlers`ï¼Œæ‰¾æœ‰æ²¡æœ‰æ»¡è¶³èƒ½è§£æçš„SOPClassHandlerï¼ŒæŠŠå…¶ä»Metadataè½¬æ¢ä¸ºDisplaySetã€‚  
   ![å›¾ 7](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-10_01-43-23.png)  
3. è°ƒç”¨`hangingProtocolService`çš„`run()`ã€å‡è®¾åªå­˜åœ¨ä¸€ä¸ªHPï¼Œè·³è¿‡æ’åæ­¥éª¤ï¼Œæ•…HPIdå°±æ˜¯å®ƒã€‘  
   è™½ç„¶ä¸æ¸…é™¤æµç¨‹ï¼Œä½†å°±æ˜¯æ ¹æ®ä»€ä¹ˆæ–¹æ³•ï¼Œæœ€ç»ˆå®‰æ’è¯¥DisplaySetï¼Œåˆ°Modeä¸­çš„èƒ½è§£é‡Šè¯¥DisplaySetçš„`viewports`ä¸­ã€‚  
   æ‰€ä»¥è™½ç„¶HPé‡Œå®šä¹‰äº†Viewportçš„æœ€å¤–å±‚æ¡†æ¶ï¼Œä½†æœ€ç»ˆè½å®çš„Viewportä¸ä¸€æ ·ï¼Œå¯èƒ½é€ æˆå±æ€§ä¸ä¸ºé¢„æœŸï¼ˆå…¸å‹çš„å°±æ˜¯ToolGroupï¼‰ã€‚
   e.g. å¯¹äºSEGç±»å‹çš„Viewportï¼Œå…¶å†…éƒ¨ä¼šé¢å¤–å¸¦ä¸€å±‚SEGViewportï¼Œå…¶`ToolGroupId`ä¸º`SEGToolGroup-0`è¿™æ ·ã€‚
   * åŒæ—¶ï¼Œå¯¹äºdisplaySetğŸ‘‰Viewportï¼Œæ˜¯æŒ‰Viewportçš„é¡ºåºï¼ŒæŸ¥æ‰¾å¯å±•ç¤ºè¯¥displaySetçš„Viewportï¼Œä»£ç å¦‚ä¸‹ï¼š  
     ![å›¾ 8](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-10_12-03-47.png)  

## åŠ è½½å½±ç‰‡æµç¨‹

ä¼šå‘ç°ï¼šåˆ°å…¨æ¡†æ¶åŠ è½½å¥½åï¼Œå½±ç‰‡æ˜¯æ…¢æ…¢åŠ è½½å‡ºæ¥çš„ã€‚  
è¿˜è®°å¾—åŸæ¥HangingProtocolä¸­è®¾ç½®çš„åŠ è½½ç­–ç•¥å—ï¼Œå°±æ˜¯è¿™é‡Œçš„åŸå› ã€‚

åœ¨Viewporté‚£äº›éƒ½è®¾ç½®å¥½åï¼Œæ­¤æ˜¯ï¼Œæ¸²æŸ“çš„å…³é”®æ•°æ®`pixelData`è¿˜å¹¶æœªè¯»å–ï¼Œæ‰€ä»¥çœ‹åˆ°çš„æ˜¯ä¸€ç‰‡ç©ºç™½ï¼Œ  
ä¹‹åï¼Œä¼šè°ƒç”¨"HangingProtocolService"çš„`runImageLoadStrategy`ï¼Œæ ¹æ®å‰é¢é€‰æ‹©çš„ç­–ç•¥ï¼Œé€æ­¥åŠ è½½åƒç´ æ•°æ®pixelDataã€‚

ç„¶åï¼Œè¿è¡Œç­–ç•¥åï¼Œå¼‚æ­¥åŠ è½½ï¼ˆæ‰€ä»¥é‚£ä¸ªäº‹ä»¶`CUSTOM_IMAGE_LOAD_PERFORMED`åªæ˜¯ä»£è¡¨åŠ è½½æ­£åœ¨è¿›è¡Œï¼‰ï¼Œ  
å‡å¦‚æ˜¯`interleaveTopToBottom`ç­–ç•¥ï¼š

ä¼šåœ¨æ¥è‡ª"@cornerstonejs/core"çš„`imageLoadPoolManager`ç®¡ç†æ± ä¸­åŠ å…¥è¯»å–æ¯ä¸€ä¸ªåˆ‡ç‰‡(Instance)çš„è¯·æ±‚(Request)ï¼ˆå¯è§å¤§çº¦115è¡Œï¼‰  
![å›¾ 9](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-11_15-28-10.png)  
å¯çœ‹æ³¨é‡Šã€‚

![å›¾ 10](images/5.Viewport%2BHangingProtocol%2BDisplaySet%2BSOPClassHandler--04-11_15-29-27.png)  

å…¶ä¸­ï¼š

* `handleArrayBufferLoad` - ä¸»è¦æ˜¯æŠŠå½±åƒæ•°æ®(PixelData, scalarData, ArrayBuffer)åŠ è½½è¿›å»