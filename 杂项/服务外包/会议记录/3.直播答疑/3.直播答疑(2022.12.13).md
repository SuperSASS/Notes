# 2022.12.13 - 直播答疑

[回放链接 - https://www.bilibili.com/video/BV1p3411X7gU](https://www.bilibili.com/video/BV1p3411X7gU)

* AI+医疗
* 算法+软件
  * 算法：规定的数据集训练，指定的测试集得到结果。
  * 软件：实现跟用户（**实际医疗工作人员**）交互。

## 0x00 - 重点

本次会议重点讲算法部分的相关点，如：

* 算法部分**工作流程**
* 算法**Baseline**介绍
* 算法**提分技巧**

## 0x01 - 背景介绍

*写文档可以参考。*

**赛题背景：**  
![赛题背景](images/3.%E7%9B%B4%E6%92%AD%E7%AD%94%E7%96%91(2022.12.13)--12-13_16-04-54.png)

**医疗背景：**

* 医疗影像是临床疾病诊断的重要方式。
* 为了实现疾病的准确诊断和疾病研究，需要引入AI辅助对医疗影像进行处理。

## 0x02 - 任务说明

* 设计医疗图像分割算法
* 设计医疗数据解析平台
* 实现3D医疗数据的导入、分割、可视化和数据分析能力

两个赛道：

* 算法  
  要求基于PaddlePaddle，在官方指定数据集上设计算法并训练，对测试集的数据进行推理预测。  
  实现在测试集上，给定任一3D医疗数据，准确地完成**医学数据的分割任务**；并且在新的、未进行训练的数据集上能有**较好的泛化性能**。
* 软件  
  实现**基于Web**的**3D医疗数据解析平台**，其中包括：
  * 医疗数据的**导入**
  * 医疗数据的**分割**
  * 医疗数据**可视化**
  * 医疗数据**分析**
  
  飞桨模型可以在**本地或云端**部署进行推理。  
  可以设计更多**相关场景的附加功能**，通过**稳定**的软件功能和优秀的人机交互，为**非AI专业人员**提供良好的用户体验。

### 1. 数据集

数据集目录如下：

* base_train
  * imagesTr - 训练集图片(160个)
  * lablesTr - 训练集标签
  * dataset.json - 训练集信息
  * imagesTs - 测试集图片(40个)

数据集由部分AMOS数据集构成，**只能使用提供的数据集**进行训练。

数据类别一共16个，包含1个背景、15个腹部器官。
数据集图片动图可使用**ITK-snap**查看。



### 2. 算法评价指标

使用$dice$系数评价指标。

![图 1](images/3.%E7%9B%B4%E6%92%AD%E7%AD%94%E7%96%91(2022.12.13)--01-10_16-43-25.png)

其中FP、TP、FN、TN属于“混淆(错误)矩阵”的内容：

![图 2](images/3.%E7%9B%B4%E6%92%AD%E7%AD%94%E7%96%91(2022.12.13)--01-10_17-00-06.png)

对于某一个数据类别（即标签、竞赛中数据集有16类）：

* TP(True positive) - 预测有这个标签，实际也有这个标签
* FP(False positive) - 预测有这个标签，实际并没有这个标签
* TN(True negative) - 预测没有这个标签，实际也没有这个标签
* FN(False negative) - 预测没有这个标签，实际却有这个标签

故：

* TP+FP - 预测结果打上标签的
* TP+FN - 真实打上标签的

在本类数据标签中，Dice系数为：

$$
dice\_coef_i = \frac{2TP_i}{FP+2TP+FN}
$$

最后打榜排名的分数为**15类（除背景）Dice平均系数**，即：

$$
score = \frac{1}{15}\sum_{i=1}^{15}dice\_coef_i
$$

### 3. 算法工作内容

**包含四个部分：**

1. 用训练集训练模型  
   基于PaddlePaddle**设计深度学习模型**，并在给定的训练集(imagesTr)上进行训练。
2. 测试集推理  
   用训练集训练好模型后，预测测试集(imagesTs)的测试分割结果。
3. 提交测试集推理结果  
   将分割结果打包成zip文件，在官网比赛页面提交。
   *Tip：Linux的打包命令为`zip -j submit.zip xxx/*.nill.gz`。*
4. 得到分数，查看排行榜  
   等待15~20min，得到排名。

**重要要求：**

1. 必须使用paddlepaddle**2.2**及以上版本，生成**端到端深度学习模型**。比赛结果后要求**提交相关模型和预测代码**复核。
2. 算法训练时，只允许使用`dataset.json`内的160条训练数据训练模型，**禁止**使用测试集数据构建伪标签、进行自监督训练等。

### 4. 软件

根据**实现的功能**评分。

要求：必须使用飞桨在本地或云端进行推理，禁止使用第三方推理工具(OpenVINO, TensorRT等)。

## 0x03 - Baseline介绍

*注：baseline(基线)个人理解就是一个基础模型，直接用这个模型就能跑一编比赛，不过效率肯定很低，我们做的就是在这个基础上进行调参改进。*

### 1. 医疗影像分割套件 - MediacalSeg

[MedicalSeg](https://github.com/PaddlePaddle/PaddleSeg/tree/release/2.7/contrib/MedicalSeg)是一个包含各种高精度模型、支持高定制化、支持智能标注的 3D 医疗影像分割方案。

![图 2](images/3.%E7%9B%B4%E6%92%AD%E7%AD%94%E7%96%91(2022.12.13)--12-13_16-12-09.png)  

从“智能标注”开始，包含“数据预处理”、“训练”、“评估”、“结果可视化”和“导出部署”等分割模型生成和应用的全流程。

![图 3](images/3.%E7%9B%B4%E6%92%AD%E7%AD%94%E7%96%91(2022.12.13)--01-10_17-22-51.png)  

基于飞桨核心框架开发，代码架构包括上图3个大部分，  
支持所有常见数据类型加载、各种数据变换、数据集、模型、influence部署和3D数据可视化功能。

具有十多种器官的分割模型和智能标注平台两大上层应用。

### 2. 模型

*【这部分是给具体负责算法的讲解的，这里不是很懂，只留下时间阶段，需要了解什么部分可在回放里看*……

* Basiline1(VNet模型) - 05:35 ~ 10:36
  * fork后文件介绍 - 05:35 ~ 06:45
  * 正式使用流程 - 06:45 ~ 09:42
    1. fork和安装依赖包 - 06:45 ~ 06:50
    2. 准备数据集 - 06:50 ~ 07:53  
       对数据集处理的代码为`prepare_data.py`，会下载数据集、归一化、重采样、将图片保存为npy格式、划分训练集和验证集。  
       参数都是默认参数没有设置（45行代码看到），重采样分辨率为$128^3$，训练集$75\%$、验证集$25\%$。  
       后面训练时可按需求设置。
    3. 正式训练 - 07:53 ~ 08:05
    4. 评估验证集精度 - 08:05 ~ 08:22
    5. 模型导出成静态图 - 08:22 ~ 08:31
    6. 对要求的测试集推理 - 08:31 ~ 09:26
    7. 结果打包上传 - 09:26 ~ 09:42
  * 快速体验推理提交 - 09:42 ~ 10:36
* Basiline1(nnUNet) - 10:36 ~ 20:52
  * fork后文件介绍 - 10:36 ~ 11:39
  * 正式使用流程 - 11:39 ~ 13:20
    1. fork、数据集解压并清理、安装依赖 - 11:39 ~ 12:20
    2. 训练模型 - 12:20 ~ 12:32  
       默认使用“五折训练策略”，可以根据需求设置。
    3. 验证精度、生成下个命令的json - 12:32 ~ 12:48  
       为了加快训练推理速度，使用的是混合精度训练。
    4. (可选)推理报错处理 - 12:48 ~ 13:00
    5. 对要求的测试集推理、打包、上传 - 13:00 ~ 13:20
  * 快速体验推理提交 - 13:20 ~ 14:38
  * nnUNet配置文件详细介绍 - 14:38 ~ 20:52

## 0x04 - 算法提分技巧

1. *数据准备（已完成）*
2. 数据预处理 - 21:24 ~ 23:40
   * 归一化 - 21:24 ~ 21:46
   * 重采样 - 21:46 ~ 22:34
   * 使用patch-training而不是resize - 22:34 ~ 23:19  
     对于不同分辨率、相同体素间距的数据，使用"patch-training"，即取一部分。
   * 数据增强 - 23:19 ~ 23:40
3. 训练 - 23:40 ~ 25:27
   * 模型设计 - 23:40 ~ 24:03  
     可使用最新的paper中的模型，包括自己添加的一些Attention、Transform的一些模块。
   * 损失函数 - 24:03 ~ 24:24  
     不同的损失函数、辅助损失函数
   * 多折训练 - 24:24 ~ 24:55  
     可以将训练集划分为多个子集，将部分子集作为训练集，其余子集当作训练集。  
     使用交叉验证的方法，比如nnUNet使用五折交叉训练，预测阶段将五个模型集成起来进行预测取平均。
     也可以训练多个模型，使用模型集成。
   * 多阶段训练 - 24:55 ~ 25:27  
     如两阶段：第一阶段把分辨率变小再训练；第二阶段把第一阶段推理结果作为部分输入，增加第二段模型上下文信息。
4. 推理 - 25:27 ~
   * 模型集成 - 25:27 ~ 25:45  
     训练多个不同的模型、设计多个不同的网络结构
   * TTA  - 25:45 ~ 25:53  
     预测时没有限制推理时长，可以使用多种TTA策略。
   * 后处理 - 25:53 ~ 26:37  
     使用后处理策略提升分割效果。  
     因为器官对应的连通区域数量固定（如肝脏只有1个），可以通过判断预测结果中连通区域数量，保留最大的连通区域作为结果。  
     孔洞填充：如器官内部有个洞，很可能是预测错误，可以使用器官类别进行填充。
   * 滑动窗口 - 26:37 ~ 26:53
     预测的时候使用滑动窗口方法进行推理。

## 0x05 - 论文资料

* [多器官分割参考论文](https://github.com/JunMa11/FLARE/tree/main/FLARE21/ShortPapers)
* [nnU-Net](https://arxiv.org/abs/1809.10486)
