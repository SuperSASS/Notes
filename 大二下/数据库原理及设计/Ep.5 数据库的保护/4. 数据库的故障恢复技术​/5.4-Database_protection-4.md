# 第四节 数据库的故障恢复技术

数据库实现故障恢复技术，主要是依靠“事务”机制。

## 一、事务管理概况

### 1. 事务的基本概念

> 定义 - 事务：
>
> 有时，某个工作的完成要分若干步骤。  
> 只有所有步骤都成功做完，则该项工作才完成；  
> 否则，其中任一步失败，该工作亦失败。

含义：

* 一个数据库操作序列
* 一个不可分割的工作单位
* 恢复和并发控制的基本单位

例如转账操作，会分成一个个步骤（检查甲方余额、从甲方扣钱、向乙方加钱等等再细分），  
这类操作要么所有步骤做完，要么都不做，不能只做一部分步骤，  
因此引入事务的概念，描述这类操作的特点。

事务是构成单一逻辑工作单元的操作集合。  
DBS必须保证事务正确完整的执行。​

关系数据库中，一个事务可以是一条或多条SQL语句，也可以包含一个或多个程序。  
而一个程序通常包含多个事务。

**事务时DBMS最小的执行单元，也是故障恢复和并发控制的最小单元。**

### 2. 事务的执行保证

控制有两种方法：

* 隐式事务控制  
  将一个数据库操作（如一条SQL语句）当成一个事务来控制执行。
* 显式事务控制  
  对涉及多步操作（多条SQL语句）、有事务特点的工作，要人为、显式地将这些操作界定为一个组合事务。

事务以`BEGIN TRANSACTION`开始，以`COMMIT`（成功提交）或`ROLLBACK`（失败回滚）结束。

状态图：
```
```

### 3. 事务的ACID准则

要求事务有以下四个重要特征或准则：

* 原子性  
  一个事务对数据库的所有操作是一个整体，要么成功执行，要么都不执行(Nothing or All)。保证原子性由DBMS的事务管理器(Transaction Manager)负责，“提交(Commit)”和“回退(Rollback)”操作是其中的关键。 
* 一致性  
  在无其它事务并发执行时，单独运行​的事务应保证DB从一个一致状态转到另一个一致状态。
* 隔离性  
  需要交错执行几个事务，但这些并发执行的事务，对用户而言就像单独执行一样。  
  即：并发执行的事务间互不干扰。
* 持久性  
  一旦事务`COMMIT`，其对数据库的影响是持久的。  
  即便数据异常、系统崩溃等，也会写入磁盘。  
  主要是利用日志的“后像”来实现持久性。

**ACID准则不容破坏**，
不仅在系统正常如此，在系统故障​时也应如此；  
在单个事务执行时如此，在事务并发执行​时也应如此。​

## 二、故障恢复导论

### 1. 故障的种类

* 事务内部故障
* 系统故障  
  计算机发生的故障，如崩溃、断电等。
* 介质故障（硬故障）  
  指外存故障，如磁盘损坏、强磁场干扰等。
* 计算机病毒

数据库能恢复前三类故障。  
其中事务故障和系统故障利用日志即可恢复，  
对于介质故障，需要先转储，再利用日志恢复。

### 2. 日志

日志只用记录更新操作，  
会记录更新的**前像**、**后像**、**活动的事务表**、**提交的事务表**。

* 前像：事务所更新的数据所在物理块，在更新前的映像。用来做`undo`操作。
* 后像：涉及物理块更新后的映像。用来做`redo`操作。
* 活动事务表ATL：记录正在执行、尚未提交的事务标识符。
* 提交事务表CTL：已提交事务的标识符。

提交更新事务应遵守的规则：

* 提交规则：要求后像应在提交前写入日志。  
  这样就算未能完全写入DB，也能根据后像，事务仍可提交。
* 先记后写规则：后像在事务提交前写入DB，需要先将前像写入日志，以便撤销。

### 3. 如何进行故障恢复

主要故障恢复的技术，基于备份和日志。

* 单纯以后备副本为基础的恢复技术  
  即只利用周期性备份，出现故障则用故障点最近的后备副本恢复。  
  但因为不可能每时每刻都备份，因此必然会导致一定的数据丢失。  
  备份时可选择“增量备份”，这样只用备份与上一次备份的增量
* 以后备副本和日志为基础的恢复技术  
  日志中存放操作历史，可根据日志重现操作，从而避免数据丢失。
* 基于多副本的数据库恢复技术  
  可以保证数据库连续不间断地工作。  
  利用镜像磁盘、双工磁盘、镜像服务器、群集系统等技术。  
  同时，**数据库级**也存在多副本，有数据库复制技术、数据库镜像技术。
  
下面介绍第二种的方案：

* 后像在事务提交前写入DB
* 后像在事务提交后才写入DB

问题：  
由于未提交的事务在系统中不多，恢复时`undo`的工作量不大；  
但对于已提交的事务，不能肯定其后像是否已写入DB，只得`redo`

改进：**设置检查点**。