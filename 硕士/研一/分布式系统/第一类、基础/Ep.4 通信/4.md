# Ep.4 通信

前三章讨论如何组成分布式系统的实体、这一层讨论怎么连起来构成分布式系统。

## 一、基础

### 1. 分层

**基本组网模型**：

即分层网络体系。  
但缺点是：只关注消息传递，因此有很多层和功能不需要，并且分布式系统违反透明度原则。

对于其中的第三层，是网络的需求，  
对于分布式系统，考虑的最低层级则是网络层。

**传输层**：

为大部分分布式系统提供实际的通信设施。

* TCP：可靠的、面向流的通信
* UDP：不可靠的、数据报通信

**中间件**：

对分布式系统并不讨论传输层以下的各种协议，而考虑其之上的中间件（中间件就位于其上存在）。  
中间件提供许多不同应用程序使用的通用服务和协议，如：

* 通信协议
* 数据（反）序列化
* 命名协议
* 安全协议
* 扩展机制

**调整后的分层**：

* 应用层
* 中间件层
* 操作系统层
* 硬件层

### 2. 通信的分类

* 按通信次数分
  * **瞬时通信**：发送只发一次，如果没有受到则丢失，不会保存状态；必须要在规定时间内处理，即紧急事件
  * **持续通信**：发送会在中间的某个地方（通信服务器）存储，没有收到会持续发送
* 按时间分
  * **同步通信**：有先后次序、时间提单
  * **异步通信**：双方不能有时间上的指定关系

**同步的时机**：

* 请求提交时
* 请求传递时
* 请求处理后

**客户端 / 服务器计算的模式**：

通常基于瞬时同步信息模型。

* 客户端和服务器在通信时必须活跃
* 客户端发送请求后阻塞，等待回复
* 服务器本质只接受请求，处理请求

缺点则是消息可能丢失，并且同步会互相等待。

因此提出“面向消息的中间件”，以实现持续的异步的通信。

## 二、远程过程调用

是持续的、**同步**的通信。

直接的理解就是调用，类似于函数调用。  
通常是一个用户空间的进程调用另一个用户空间的进程，这两个用户空间可以不在一个实体机上。

关键：利用 stub（存根） 来提供函数、构建消息、通信、解压缩结果。

涉及到参数、数据的传递，要正确处理数据。

RPC 假设：不能对参数进行修改（复制入+复制出），但可以通过全局变量紧耦合。  
因此 RPC 无法实现完全透明度。

**变体**：

* 异步 RPC
* 同时发送多个 RPC

**实例 - DCE**：

有一个 Directory Server，用于服务器注册服务、客户端查找服务；  
服务器上有一个 DCE daemon，用于服务器注册端口、客户端查找端口；  
客户端先从 Directory Server 查找服务器地址、然后从 DCE daemon 查找服务端口，然后调用。

## 三、面向消息的通信

是持续的、**异步**的通信。

* 瞬时的消息传递 - 套接字

使用基础的套接字很低级，容易犯编程错误，故存在 **ZeroMQ** 进行封装，具有以下模式：

* 响应-请求
* 发布-订阅
* 管道  
  发布的叫 source,接受的叫 worker

如果需要更大的灵活性来做分布式系统，可以用 **MPI**。

消息中间件：支持中间件级**队列**。  

* 消息队列
* 消息路由

* WebSphere MQ
* AMQP

## 四、组播通信

* 应用级树形多播
* 洪水式多播：给所有邻居分发
* Gossip 数据分发：有选择的分发（只让部分人听）

一些模型：

* 流行病传播（反熵）
* 谣言传播