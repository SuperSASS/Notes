# Ep.6 复制和一致性

## 一、以数据为中心的一致性模型

这个是对数据本身而言的一致性。

一致性模型是分布式数据存储与进程之间的契约，规定了各项组合后的读写操作的结果。

### 1. 持续一致性

**如何描述一致性**：

* 数值上差异
* 陈旧性
* 更新操作在数量（更新了多少）和顺序（谁先谁后）上存在差异

**相关概念**：

* 更新单元(Conit)：要度量的一致性单元  
  当更新单元一致时，才说明两副本一致。
* 操作(Operation)表：记录本副本已知所有的操作、标注已做（已持久化）的操作
* 矢量矢量：保存自己和知道的其他副本更新的程度。
* 待做操作：自己的操作还有多少没做
* 其他副本信息：对其他副本不知道的更新的个数，以及这部分更改值

### 2. 顺序一致性

如果每个单独进程的操作，均按照某种（其程序规定的）相同的顺序出现，则**任何执行的结果都是相同**的。  
顺序一致性并不是一定要保证的。

**读写操作符号定义**：

* $W_i(X)a$ - 进程$P_i$将变量$x$写为值$a$
* $R_i(x)b$ - 进程$P_i$将变量$x$读出值$b$

**如何解决 - 线性化**：  
让所有操作在开始和结束时间内必须完成，  
常见的锁、信号量等都是为了线性化。

### 3. 因果一致性

所有进程必须以相同的顺序，看到具有潜在因果关系的写入。  
比顺序一致性更低。

### 4. 条目一致性

* 对锁的访问是顺序一致的
* 在所有先前的写入操作全部完成之前，不允许对锁的任何访问
* 在所有先前的锁访问完成之前，不允许执行任何数据访问

涉及锁、临界区的概念。

### 5. 最终一致性

在分布式系统中，可以容忍相对程度较高的不一致性的复制数据库。  
只要最终保证更新能传播到所有部分就行。

成本很低。

**解决方法**：

使用一个独立的存储曾，在这一层实现因果一致性。  
已证明因果一致性在网络分区存在的情况下，是可以实现的最佳一致性

## 二、以客户端为中心的一致性模型

这个是针对客户的行为（动作）的一致性。  
虽然数据可能是一致的（最终一致性），但对用户使用来说，可能不一致。

问题：移动用户因为移动，可能访问分布式数据库的不同副本。

**四种策略**：

* 单调读
* 单调写
* 读取自己的写入
* 写入跟随读取

## 三、一致性协议

* 复制写协议
  * 基于法定人数的协议(Quorum-Based Protocols)