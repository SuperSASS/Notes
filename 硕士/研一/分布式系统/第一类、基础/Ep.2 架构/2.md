# Ep.2 架构

## 一、架构风格

架构将分布式系统逻辑组织为**软件组件**，  
**架构风格**组成：

* 具有明确定义接口的（可更换）**组件**
* 组件间的相互**连接方式**
* 组件之间交互的**数据**
* 如何将这些组件和连接器联合**配置到系统中**  
  > 连接器：一种调解组件之间通信、协调和合作的机制，如（远程）过程调用、消息收发、流式处理。  
  > 连接器允许组件之间的控制流和数据流。

使用**组件**和**连接器**，可以得到各种各样的配置，这种配置则是软件架构。

最重要的架构如下。

### 1. 分层架构

分层一定是上层调用下层，下层不能直接调用上层；  
但下层可以向上层传播消息，称为"Upcall"。

**概念**：

* 接口：同一组件中的不同层，下层可供上层调用的方法
* 协议：不同组件之间的同一层，相互传递信息的约定
* 服务：不同组件的同一层构成的整体，对外提供的服务

**传统三层视图**：  
许多分布式系统都包含这三层。

* 应用程序接口层：应用和用户的接口
* 处理层：只包含应用程序的功能、**没有数据**
* 数据层：希望通过应用程序组件操作的数据

### 2. 基于对象和面向服务的体系架构

对象和服务是现实中就存在的概念，因此是用来描述现实需求的，是**面向问题、需求**的角度。

本质上组件就是对象，可以通过调用来连接，  
而对象可以分不到不同机器上，通过远程调用连接。

**服务**本身就意味着分布式，放在不同的机器上，即 SOA。

### 3. 以资源为中心的架构

将分布式系统视为由组件单独管理的**资源集合**。远程调用程序可以增删查改资源。  
如: RESTful 风格架构。

要点：

1. 通过单个命名方案标识资源
2. 所有服务都提供相同接口
3. ……

只能处理数据，不能作为系统。

区别：SOAP - 利用定义的各方法以及相应参数来操作资源； RESUful 的 url 直接包含操作和参数。

### 4. 基于事件（发布订阅机制）的架构

存在两种耦合：

* 时间耦合(T)
* 引用耦合(R)（解耦则是空间解耦）

对于以下四种情况：

* TR: 直接协调（调用）
* T: 基于时间
* R: Mailbox
* None: 共享数据空间

问题：

* 对于简单信息的发布还可以，但如果需要进行复杂判读（只关注感兴趣信息）则需要进行大量逻辑判断
* 如何确保可扩展性

## 二、中间件组织

* 问题：传统组件提供的接口可能**不适合所有应用程序**
* 解决方案：
  * 包装器 Wrapper
  * 适配器 Adapter

### 1. 包装

有两种方案：

* 直接包装(1-on-1): 每一个组件对另一个组件编写一个包装器，需要$O(N^)$个 Wrapper
* 代理(Proxy): 用一个代理组件，向其他组件提供 Wrapper、其他组件也通过 Wrapper 包装代理，需要$O(N)$个 Wrapper

### 2. 拦截

在执行一个调用的过程中，进行拦截，执行特定逻辑代码，再将处理后的数据继续调用。  
可能有多个拦截器，从而控制数据和行为流。

### 3. 可修改的拦截器

## 三、系统架构

### 1. 集中式组织

* CS 模型
  * 单层架构：接口、应用、数据都放在客户端上
  * 两层架构：接口、应用和数据部分放在客户端上、部分放在服务器上（胖瘦客户端）
  * 三层架构：接口放在客户端上、应用和数据单独放在各自的服务器上

### 2. 去中心化组织

* 垂直分布：将分布式应用划分为三个逻辑层，并在不同服务器上运行每个层的组件
* 水平分布：逻辑对等
* 点对点分布(P2P)：进程之间都是平等的，各自充当客户或服务。  
  * 需要使用无语义索引：每一个数据项都与唯一一个键关联，从而可以索引。需要使用哈希函数。  
    实现示例：
    * 超立方体
    * Chord(环)
    * 大规模节点网络 - 随机方法：泛洪(flooding)、随机游走(random walk)
    * 分层组织的网络

### 3. 混合架构

如：

* 互联网: 对整个互联网是对等架构、但对 ISP 是边缘网络上的集中式架构。
* BitTorrent: 有一些中心服务器(Web Server, File Server)提供服务，但数据是分布到各结点存储的。
