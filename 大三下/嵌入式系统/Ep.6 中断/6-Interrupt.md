# Ep.6 中断

## 一、定义

### 1. 什么是中断

就是可以不断被打断的事件，一般都会根据优先级确定顺序。

* 主程序
* 中断源
* 中断服务程序

中断与异常有类似，但存在区别。  

* 中断：由外部事件触发（与硬件相关）
* 异常：由CPU内部事件触发（与软件相关）

本书中一般统一称为“中断”。

### 2. 为什么用中断

因为CPU速度快、外设速度慢，需要等待，如果一直等待会造成CPU效率降低，  
采用中断**提高CPU效率**。

* 可提高CPU效率
* 可实现对**实时**事件的及时处理（实现实时性必须用中断）
* 可对突发故障进行及时处理

### 3. 中断处理流程

* **中断请求**：中断源向CPU发送中断请求信号，此时中断控制系统的中断请求寄存器被置位，向CPU请求中断
* **中断响应**：CPU判断中断请求是否符合中断响应条件，如果符合则响应，中断当前程序并控制程序跳转到中断服务程序；不符合则忽略
* **中断服务**：为处理中断编写的程序，由开发人员实现
* **中断返回**：退出中断服务程序，返回到中断请求响应之前被中止的位置，继续主程序

## 二、 STM32的内部中断

有MCU上的中断，还有片内的外设中断。

### 1. 中断和异常向量表

> Cortex-M3的中断：
> 
> Cortex-M3支持256个中断：
>
> * 15个内核中断
> * 240个外部中断
>
> 可以设置优先级，除了3个固定的高优先级，其余均可以由用户设定优先级。

对于STM32F10x，对中断进行了精简，  
有84个中断通道，包括16个内核中断和68个可屏蔽中断。（103系列只有60个可屏蔽中断；107有68个）

---

> 定义 - 中断向量：
>
> 向量就是指地址或指针，存放了**中断服务程序的入口地址**。  
> 再有入口地址找到中断服务程序。

中断向量编址从0地址开始，占用4个地址字节。

中断向量表及时由中断入口地址（中断向量）组成的表。

STM32中存在大量宏定义，配置中断时可直接使用这些宏。

### 2. 优先级

STM32的NVIC支持16级，但一般只用2级就可以。  
NVIC中断配置的相关函数在`misc,h`庫中。

* `NVIC_PriorityGruopConfig` - 中断分组管理函数：用于设置中断的优先级分组  
  一般都选`NVIC_PriorityGroup_0`,`NVIC_PriorityGroup_2`
* `NVIC_Init` - 中断初始化函数
  参数结构体：
  * `NVIC_IRQChannel` - 中断源、IRQ通道
  * `NVIC_IRQChannelPreemptionPriority` - 抢占优先级
  * `NVIC_IRQChannelSubPriority` - 响应优先级
  * `NVIC_IRQChannelCmd` - **使能**中断通道（Enable或Disable）

**中断优先级判断原则：**

* **高抢占优先级**的中断可以打断低抢占优先级的中断服务，形成中断嵌套
* 中断优先级**数值越小**，级别越高
* **抢占优先级**的优先级总是**高于响应优先级**
* Reset, NMI, Hard, Fault的优先级为负，且不可修改，故高于普通的中断优先级

**优先级判断方法：**

判断时，先判断抢占优先级大小；  
如果抢占优先级相同，则比较响应优先级；  
如果都相同，则按照中断向量表的顺序来决定。

### 3. 中断服务程序

STM32将中断服务程序统一放在标准外设库`stm32f10x_it.c`中，  
其中每个中断服务函数都只有函数名，函数体是空的。  
用户**编写相应的函数体**即可。

## 三、外部中断EXTI

### 1. 两种模式

STM32芯片之外的外设中断由EXTI和NVIC共同负责，每个GPIO引脚都可以配置为一个外部中断触发源。  
支持19个外部中断/事件请求，每个有独立的触发和屏蔽设置，具有中断模式和事件模式两种。

* 中断模式：外部信号的边沿产生中断信号传送给NVIC，触发中断，最终实现中断服务程序的执行。  
  由**软件实现**响应功能。
* 事件模式：产生脉冲，将系统从睡眠和停止模式中唤醒，从而产生相应外设的触发信号，供外设电路使用  
  属于硬件触发执行的过程。

### 2. 结构

存在以下寄存器：

* 中断屏蔽寄存器：用掩码来设定中断屏蔽，将经过屏蔽的中断信号送入NVIC中断控制器
* 事件屏蔽寄存器：一般只关心中断，事件由硬件实现
  * 脉冲发生器
* 请求挂起寄存器：输入的中断信号都存在这里，NVIC按需选择然后切入
* 软件中断事件寄存器
* 上升沿触发选择寄存器
* 下降沿触发选择寄存器

### 3. 外部中断线

有19条：

* 线0～15：对应I/O引脚的外部中断
* 线16：连接到PVD输出
* 线17：连接到RTC闹钟事件
* 线18：连接到USB唤醒事件

GPIO中断是**以组为单位**的，从PAx到PGx为一组，  
如果PAx作为外部中断源，则其他如PBx～PGx就不能再同时作为外部中断使用了。

### 4. 中断服务程序

* EXTI0~EXTI4：有独立的中断服务程序，如`EXTI3`对应`void EXTI3_IRQHandler(void);`
* EXTI5~EXTI9：共用一个，`void EXTI9_5_IRQHandler(void);`
* EXTI10~EXTI15：共用一个，`void EXTI15_10_IRQHandler(void);`

### 5. 标准外设库的接口函数

在`stm32f10x_exti.c`中定义了EXTI相关的库函数：

* `EXTI_DeInit`
* `EXTI_Init` - 定义`EXTI_InitTypeDef`结构体
* `EXTI_StructInit`
* `EXTI_GetFlagStatus` - 用于检查指定的EXTI线路触发请求发生与否，返回`SET`或`RESET`
* `EXTI_ClearFlag`
* `EXTI_GetITStatus`
* `EXTI_ClearITPendingBit` - 中断悬挂相关，清除EXTI线路悬挂位（做完了中断服务后要清掉，否则死循环）

配置步骤：

1. GPIO吃书画配置
2. 开启I/O端口的时钟和复用时钟：GPIO用作EXTI外部中断功能引脚，必须开启复用功能，打开AFIO时钟。
3. 设置I/O引脚与中断线路的映射关系：GPIO引脚与响应中断线关联在一起
4. 初始化EXTI、配置EXTI相关参数并使能
5. 初始化NVIC，配置NVIC参数并使能：配置中断优先级的中断分组，确定各具体中断的抢占优先级和响应优先级大小。
6. 编写中断服务程序：包括检测中断线路的状态、中断处理的内容和清除相关的中断。  
   比如：
   ```c
   void EXTI2_IRQHandler(voud)
   {
       if (EXIT_GetITStatus(EXTI_Line2) != RESET) // 判断某个线上的中断是否发生
       {
           // 中断处理
           EXIT_ClearITPendingBit(EXTI_Line2);// 记得清除
       }
   }
   ```
