# Ep.2 ARM Cortex-M3内核与STM32微控制器

## 一、基础知识

### 1. 冯诺依曼和哈佛架构

冯诺依曼体系结构：

* 由运算器、控制器（前两者合称CPU）、存储器、输入设备、输出设备五大部件构成。
* 指令地址和数据地址，指向同一个存储器的不同物理位置，统一编址，宽度相同
  因此，冯诺依曼结构的计算机，不能同时取指令和取数据。

哈佛体系结构：

* 指令存储器、数据存储器独立编址、独立访问，指令和数据分别存储在两个独立的存储器中，
  使用两条独立的总线，分别于CPU进行信息交换，
  故数据和指令的存储可以同时进行。
* 容易实现指令流水

### 2. ARM存储模式

计算机存储器都是以字节(Byte)为单位进行划分的，每个地址单元都对应着一个字节，8位。

* 小端模式(Intel模式)：数据的低字节，存放在内存低地址处
* 大端模式(Motorola模式)：数据的高字节，存放在内存低地址处

> 举例 - 小端大端模式：
>
> 如，存储数据`0x12 34 56 78 9A`。
>
> | 地址 | 小端 | 大端 |
> | ---- | ---- | ---- |
> | 0x04 | `12` | `9A` |
> | 0x03 | `34` | `78` |
> | 0x02 | `56` | `56` |
> | 0x01 | `78` | `34` |
> | 0x00 | `9A` | `12` |

*一般的PC机，常采用小端模式。*

### 3. CISC和RISC

有关指令：把特定的`0`和`1`组成的序列当作指令，通过指令来操作计算机。

* CISC：固定指令集计算机
  * 指令系统丰富、**长度不固定**
  * 一般只用于专用的计算机
* RISC：精简指令集计算机
  * 指令少（选用頻率较高的简单指令）、**长度固定**
  * 简化硬件，方便硬件对指令的解析
  * 便于指令流水线
  * 绝大部分指令的操作，均在运行速度最快的寄存器内完成
  * 遵守了8020原则

* 价格 硬件结构复杂、芯片成本高 结构简单、成本低
* 流水线 减少代码尺寸、增加指令执行周期、注重硬件执行指令的功能性 使用流水线降低指令的执行周期，增加代码密度
* 指令集 长度不固定、大量混杂指令 长度固定
*

### 4. 流水线技术

将每条指令分解为多步，让各步并行运行

一般分为三部分：

* 取指令
* 取操作数
* 执行指令

**指标：**

* 吞吐率
* 加速比

## 二、ARM

**几种理解：**

* ARM - 公司：主要业务是设计16位和32位嵌入式处理器，注重低功耗、性价比
* ARM - 技术：Advanced RISC Machines32位RISC处理器体系架构（ARM不生成芯片，只卖技术，所以同技术具体生产时都不一样）
* ARM - 微处理器芯片和产品的统称：指采用ARM技术开发的RISC处理器的统称

ARM专门从事基于RISC技术芯片的设计开发，不直接生产芯片，而是转让技术设计许可，由合作公司生产各具特色的芯片。

### 1. ARM体系架构

> 定义 - 计算机体系结构：
>
> 指计算机的逻辑结构和功能特性。

主要包括微处理器所支持的指令及，和基于该体系结构下微处理器的编程模式。
开发人员主要需要知道指令系统和寄存器。

不同公司有不同基于ARM的产品，主要看其“内核架构”是什么（比如LM4Fxxxx系列，为Cortex-M4），
内核架构相同的，指令系统几乎一样。

**Cortex系列处理器：**

* Cortex-A - 应用程序型：虚拟内存系统架构，适用于高端消费电子领域
* Cortex-R - 实时型：针对高性能高实时性的应用
* Cortex-M - 微控制器型：低功耗、高性能、成本敏感的产品，面向嵌入式和工业控制领域
  * Cortex-M3
  * Cortex-M4
  * Cortex-M5

### 2. Cortex-M3

* 基于ARMv7-M体系结构

**组成：**

* Cortex-M3微处理器
  * Cortex-M3内核
    * 中央处理器核心(Cortex-M3 Core)：指令提取单元、译码单元、寄存器组、ALU
    * 嵌套向量中断控制器(NVIC)：用于实现快速、低延迟的异常中断处理
    * 系统时钟(SYSTICK)：24位倒计时计数器，可作为系统定时器，用于产生定时中断
    * 存储器保护单元(MPU)：用于对存储区域的访问保护，防止用户程序破坏存储区域的关键数据
      嵌入式有一种特殊的机制，即看门狗(Watch-Dog)，专门用于监视程序是否正常执行
    * 总线矩阵(AHB互连网络)
  * 调试系统
    * 串行线/串口JTAG调试端口(SW-DP/SWJ-DP)
    * 基于AHB总线的通用调试接口(AHB-AP)
    * 嵌入式跟踪单元(ETM)
    * 数据观察点触发器(DWT)

#### (1) 内核结构

组成：(ARM公司)Cortex-M3内核 + (各大半导体公司)针对不同应用场合领域，通过添加不同的外设以增加不同的功能 = 芯片级的计算机

Cortex-M3芯片里，由ARM设计的只有“Cortex-M3型内核”和“调试系统”，
然后内核通过“总线”连接，与各种“外设”、”处理器“、”时钟和复位“、”I/O“连接。

*注意这里的外设是芯片内的，在嵌入式中外设分“片内外设”和“片外外设”。*

#### (2) 寄存器

组成：
晶体管→基本门电路→触发器（存储1位二进制数据）→寄存器（存储1串二进制数据）

两大类：

* CPU内部的寄存器
* 外设I/O接口中的寄存器：用于对外设的状态或数据等进行存储（即接口）
  通过I/O接口和存储器统一编址，则可以对外设寄存器进行读和写，即可实现对外设控制

ARM Cortex-M3：

* 13个32位通用寄存器 - R0~R12
* R13、R14、R15三个寄存器有专门的用途
  * R13 - SP：堆栈指针寄存器
  * R14 - LR：
  * R15 - PC：就是程序指针寄存器
* 特殊功能寄存器
  * 程序状态寄存器
  * 中断屏蔽寄存器
  * 控制寄存器

#### (3) 存储结构

* 存储器和外设统一编址
  设置部分存储器地址范围用于外设的访问，将这种通过存储器地址访问外设的方式，称为“存储器地址映射”

#### (4) 中断与异常(NVIC)

> 区别 - 中断与异常：
>
> * 异常：**打断**程序**正常**执行顺序的事件
> * 中断：一般指来自外部的片上**外设**或外扩的外设的中断**请求**事件
>
> 只是异常一般而也是通过中断来实现的。

Cortex-M3内核支持256种异常和中断：

* 中断编号`0`~`15` - 系统异常
* 中断编号大于16 - 全是外部中断

外部中断一般写为IRQs，
Cortex-M3具有256级可编程的中断优先级设置（但一般只设两级就行）。

一些常见的异常中断

* `0` - N/A - 没有优先级 - 没有异常
* `1` - Reset - 优先级-3（最高） - 就是复位

内核集成了一个外设“**NVIC**”，专用于负责中断。

**作用：**

* 统一管理和配置中断
* 通过优先级来控制中断的嵌套和调度
  注：优先级越小（可为负数）越高

**特性：**

* 可嵌套中断支持，即高优先级的中断可以打断低优先级的中断
* 向量中断支持，缩短中断延迟时间
* 动态优先级调整支持，可以在运行时更改中断优先级（一般不这么做，除非实时性要求很高）
* 引入新特长新技术，中断延迟大大缩短
* 中断可屏蔽

**响应中断过程：**

* 保护现场：相关信息压入堆栈（有最大嵌套级数）
* 取向量：找到相应中断服务程序的入口地址
* 更新寄存器：PC和LR、