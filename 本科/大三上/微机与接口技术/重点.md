# 复习

## Ep.1 绪论

* 硬件结构
  **存储程序、程序控制**
* 微机硬件核
* 三总线

## Ep.2 8086

### 一、CPU组成

* BIU - 总线接口部件
  实现CPU对外部三**总线的控制**，并与外部进行**数据交换**。
* EU - 指令执行部件
  作用是执行指令。
  指令队列中的指令经EU控制系统，转换成具体的操作控制信号，并实现指令规定的运算或操作。

### 二、寄存器

* 通用寄存器
  * AX
  * BX
  * CX
  * DX
* 指针及变址寄存器
  * IP
  * BP
  * SP
  * SI
  * DI
* 段寄存器
  * CS
  * SS
  * DS
  * ES
* **标志寄存器**
  * 状态标志（6位） - 存放运算结果状态
    * (Bit#0)CF - 进位
    * (Bit#2)PF - 奇偶（第8位`1`的个数为偶数置`1`，相当于第8位偶校验）
    * (Bit#4)AF - 半进位（第3位向第4位有进位置`1`）
    * (Bit#6)ZF - 零（为零置`1`）
    * (Bit#7)SF - 符号（为负数置`1`）
    * (Bit#11)OF - 溢出（超出范围置`1`，与进位不同）
  * 控制标志（3位） - 控制某些特殊操作（用户可写）
    * (Bit#8)TF - 跟踪标志（为`1`是单步工作方式（单步调试））
    * (Bit#9)IF - 中断允许（为`1`表示可以响应可屏蔽中断）
    * (Bit#10)DF - 方向标志：控制地址指针变化（为`0`递增；为`1`递减）

### 三、周期

* 总线周期：CPU完成一次总线操作
* 基本总线周期：至少需要4个时钟周期
* 始终周期：CPU最小的一个时间单位

### 四、指令

* `MOV`、`IN/OUT`区别
  * `MOV`寻址存储器，范围$2^20=1M$
  * `IN/OUT`寻址外设，范围$2^16=64K$
* CPU如何选择存储器奇、偶地址单元？
* 存取存储单元字数据，为什么要从偶地址开始？

### 五、工作模式（最大最小）

* 工作方式
  * 局部总线工作：各主控部件挂接于**局部总线**上，共用一套总线的隔离驱动部件。放弃总线控制权的主控部件，需将引脚置于**高阻态**。
    掌握总线的主控部件，操控隔离驱动部件，从而实现与系统总线上的受控部件之间的信息交换。
  * 系统总线工作：各主控部件挂接于**系统总线**上，放弃总线控制权的主控部件芯片不是将自身引脚置于高阻态，而是在**总线仲裁器**的控制下将部件与系统隔离开。
* LOCK信号

## Ep.7 输入输出接口

* 外设端口(I/O端口)
  指：接口电路内部必须具备一些不同功能的，可以由CPU三总线按特定地址进行访问的单元。
  一个接口即为一个外设，内含多个不同的端口，种类如下：
  1. 输入数据/输出数据寄存器组
  2. 控制寄存器组
  3. 状态寄存器组
* CPU与外设数据传送方式
  加粗的三个要掌握
  1. 无条件传输方式
  2. 程序**延时**传送方式
  3. 程序**查询**方式
  4. **中断**方式
  5. 直接存储器存取方式(DMA)
  6. 通道控制方式
* 连线设计方式
  * 低位 - 片内寄存器选择（端口）
  * 高位 - 产生片选信号（接口）

## Ep.9

### 1. 8255

* 工作方式

### 2. 8254 - 计时器

* 工作方式  
  下降沿计数。  
  均需要门控信号`GATE`有效才会计数。
  * 方式0 - 简单**上升沿**计数器：写控制字 输出**低**电平、写入初值 `GATE`高电平 下一个`CLK`下降沿 **重新**开始计数、`GATE`低电平 **暂停**计数、到$0$输出高电平
  * 方式1 - 门控**上升沿**计数器：写控制字 输出**高**电平、写入初值 不直接写入 等门控`GATE`正脉冲、`GATE`正脉冲 下一个`CLK`下降沿 **重写**初值 输出**低**电平 开始计数、到$0$输出高电平
  * 方式2 - **负脉冲**发生器：写控制字 输出**高**电平、写入初值 `GATE`高电平 下一个`CLK`下降沿 **等正在计数结束一轮**开始计数、`GATE`低电平 **停止**计数、到$1$输出低电平（下一个`CLK`下降沿 复位为计数初值）
  * 方式3 - **方波**发生器：写控制字 输出**高**电平、写入初值 `GATE`高电平 下一个`CLK`下降沿 **等正在计数结束一轮**开始计数、`GATE`低电平 **停止**计数、到**一半**输出低电平（到$1$后下一个`CLK`下降沿归为计数初值）
  * 方式4 - 简单**负脉冲**计数器：类似方式0，不过输出负脉冲
  * 方式5 - 门控**负脉冲**计数器：类似方式1，不过输出负脉冲

### 3. 8259 - 中断控制器

#### (1) 中断相关

* 中断源识别方法
  * 软件查询法：把中断源都放在一个缓冲器(8255)里，有中断请求时直接从里面查即可
  * 中断矢量法：由硬件控制电路形成一个供CPU**识别中断源**的中断向量号，由此可获取中断服务程序的入口地址
* 中断判优方式
  * 软件判优：CPU接收到INTR后，按优先级逐个检查外设中断请求标志位
  * 硬件判优：菊花链优先权排队电路
* 中断优先级
  1. 除法
  2. `INT`
  3. 溢出
  4. 断点
  5. `NMI`
  6. `INTR`
  7. 单步中断（调试）
* 过程
  * `PSW`**入栈**
  * 复位`IF`和`TF`
  * `IP`**入栈**、`CS`**入栈**
  * 根据中断向量号得到中断服务程序入口地址，然后装入`CS, IP`
  * （没嵌套情况下）*执行中断服务程序*（保护现场什么的都在中断服务程序中程序员自己写）
  * 中断返回，弹出`CS`，弹出`IP`，弹出`PSW`
  * 返回被中断的程序(`CS:IP`)

#### (2) 8259

![图 1](images/%E9%87%8D%E7%82%B9--03-04_00-28-41.png)  

* 优先级方式
  * 普通全嵌套方式：`IR0`的优先级最高，`IR7`最低，只允许高优先级。  
    适用于单片8259，或从片8259中。
  * 特殊全嵌套方式：`IR0`最高`IR7`最低，允许高和同优先级。  
    主从结构，8259主片设置。
  * 自动循环方式：初始`IR0`最高`IR7`最低，组成循环圈，一个中断完成后，最后优先级变为其后一级。
  * 特殊循环方式：跟自动循环一样，不过可以设定初始优先级。
* 中断结束方式
  * 自动中断结束方式：在第二个$\overline{INTA}$后沿，自动完成ISR复位  
    是在中断响应后复位，而**不是中断结束后**，因此只用于中断请求信号**持续时间有限**，且**不出现中断嵌套**情况下。
  * 一般命令字中断结束方式：对ISR当前为`1`最高优先级的复位
  * 特殊命令字中断结束方式：因为没有固定的优先级序列，需要用特殊方式指明复位
* 中断屏蔽方式
  * 普通中断屏蔽方式：对中断屏蔽寄存器IMR设`1`即可
  * 特殊中断屏蔽方式：用OCW1屏蔽后，再清除ISR当前响应位，用于再当前中断服务中屏蔽等优先级中断。

### 4. 数模转换

#### (1) D/A相关

![图 2](images/%E9%87%8D%E7%82%B9--03-04_13-53-13.png)  

#### (2) DAC0832

* 输出：为**电流形式**，需要转换为电压
  * 单极性电压输出：输出某一正负性的电压  
    ![图 3](images/%E9%87%8D%E7%82%B9--03-04_14-10-48.png)  
    $$
    V_{out} = -V_{ref} * D/256\quad(\textrm{反相})
    $$
    其中$D$是输入编码的数值
  * 双极性电压输出：  
    ![图 4](images/%E9%87%8D%E7%82%B9--03-04_14-10-59.png)  
    $R_2=R_3=2R_1$
    $$
    V_{out} = (2D / 256 - 1) V_{ref}\quad(\textrm{同相})
    $$
* 工作方式
  * 无缓冲模式：两个寄存器都直通，输出始终跟随输入，此时不能直接跟数据总线相连，需要加并行接口。
  * 单缓冲模式：使输入锁存器或DAC寄存器二者之一处于直通，只占用一个端口地址  
    只需一次写入：`OUT DX, AL`
  * 双缓冲模式：写入两次，当输入寄存器控制信号有效`ILE`有效，才写入输入寄存器；当DAC寄存器控制信号有效，才写入DAC寄存器，然后进行变换。  
    需要写入两次：`MOV DX, port1(连接0832的\CS); OUT; MOV DX, port2(连接0832的\XFER); OUT`

#### (3) ADC0809

![图 5](images/%E9%87%8D%E7%82%B9--03-04_14-42-16.png)
