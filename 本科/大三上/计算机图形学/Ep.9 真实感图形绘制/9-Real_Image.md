# Ep.9 真实感图形绘制

**主要内容：**

* 隐藏线隐藏面消除
* 光照模型
* 基于简单光照模型的多边形绘制

**图形绘制过程：**

根据假定的**光照条件**和景物外观因素，依据一定的**光照模型**，计算可见面投射到观察者眼中的**光强度**大小，并转换为适合图形设备的**颜色值**，生成投影画面上每一个像素的光强度。

* 场景造型
* 取景变换、观察变换
* 后向面剔除
* 透视投影
* 隐藏面消除
* 不同物体的物理参量之间的关系

## 一、消隐算法

物体的消隐或隐藏线面的消除，指在给定视点和视线方向后，决定场景中哪些物体的表面是可见的，哪些是被遮挡不可见的。  
称为可见面判别或**隐藏面消除**。

在剔除了不可见面后，还有可见面的遮挡。

故根据实现方式，**分为两类**：

* 景物空间消隐算法
* 图像空间消隐算法

在两者之间的，还存在部分算法，如：深度排序算法、区域细分算法、光线投射算法。

**提高效率的基本原则：**

* 排序：各景物表面**按照距离视点远近排序**的结果，用于确定消隐对象之间的**遮挡关系**。
* 连贯性：是指所考察的物体或视区内的图像局部保持不变的一种性质，用于提高排序效率。
  * 物体的连贯性
  * 面的连贯性
  * 区域的连贯性
  * 扫描线的连贯性
    * 区段
    * 相邻扫描线
  * 帧的连贯性
    * 相邻帧之间
* 包围盒技术：用来初步判断相交关系，防止盲目面与面求交  
  常见的包围盒有：
  * 长方体
  * 圆柱
  * 圆柱

### 1. 深度缓存器算法

是**图像空间**的消隐算法。

对于帧缓存，需要两种信息：

* 颜色信息 - 该像素的颜色值
* 深度信息 - 该像素是由离我们多远的像素所决定的

**基本思想：**

绘制时每次计算该采样点的深度，若低于当前深度缓存器中的深度则不处理；否则更新。  
最终则能绘制出深度最大，即离相机越近的部分。  
深度缓冲器中内容即为消除隐藏面后的图像。

**算法步骤：**

1. 初始化：把Z缓存中各$(x,y)$单元置为z的最小值，而帧缓存各$(x,y)$单元置为**背景色**。
2. 在把物体表面相应的多边形扫描转换成帧缓存中的信息时，对于多边形内的每一采样点$(x,y)$进行处理：
   * 计算采样点$(x,y)$的深度$z(x,y)$
   * 如$z(x,y)$大于Z缓存中在$(x,y)$处的值(即更靠近视点)，则更新Z缓存中的$(x,y)$处，再把多边形在$z(x,y)$处的颜色值存入帧缓存的$(x,y)$地址中；否则不处理。

**深度值计算方式：**

假定多边形平面方程为$Ax+By+Cz+D=0$，则$(x,y)$深度值为：

$$
z(x,y\frac{-Ax-By-D}{C}
$$

可利用扫描线和像素的**连贯性优化**：

* 扫描线上后继点的深度值，可以利用前一点的深度值得到：  
  $$
  z(x+1,y)=z(x,y)-\frac{A}{C}
  $$
* 下一条扫描线上最左侧点的深度值，可以利用上一条扫描线最左侧点的深度值得到：  
  $$
  x|_{y-1,min}=x|_{y,min}-\frac{1}{k}
  $$

缺点：  
不能实现透明效果（因为直接进行颜色替换），  
改进的话，采用“*A缓存器算法*”。

### 2. 深度排序算法（画家算法）

类似于现实画家作画，先画最远的，依顺序画到最近的，  
这样最近的就能覆盖最远的，最后达成消隐的效果。

因此算法关键是**多边形排序**。

**算法步骤：**

1. 生成深度优先级队列  
   距视点距离远的多边形优先级低，排在队列的前端；反之在后。
2. 从队列中依次取出多边形，计算表面光亮度
3. 写入帧缓冲器
4. 重复2、3步骤，直到队列为空

**异常情况：**

空间中面的先后关系可能不好直接判断，如下图。  
![图 3](images/9-Real_Image--12-01_09-32-46.png)  
因此需要判断相交和循环遮挡，若存在则要风格。

## 二、光照模型

### 1.概念

根据物理**光学相关定律**，计算物体**表面某点**处，向观察者眼中的**光强度**的数学模型。

**描述一下三种现象：**

* 吸收
* 反射、折射
* 透射

后两点不仅取决于景物表面的**表面特性**（表面颜色），还取决于入射光源的**照明特性**（光的颜色）。

#### (1) 表面特性

* 景物表面的材质
  * 反射系数 - 决定入射光线中有多少光线被反射
  * 透明性 - 决定有多少光线从物体后面透射出来
* 景物表面的朝向
* 景物表面的与光源的相对位置

#### (2) 照明特性

* 几何性质
  * 点光源
  * 线光源
  * 面光源
  * 体光源
  * 平行光/非平行光
  * 聚光光源（舞台灯光）：断角、偏心角、聚光指数
* 色彩
* 光强分布
* 方向

#### (3) 光照模型

* 简单光照模型  
  只考虑光源直接照射在景物表面光照效果。  
  假定物体表面理想光滑。
* 局部光照模型  
  以实际物体表面的微平面理论为基础，反映表面的**粗糙度**
* 整体光照模型  
  考虑环境对景物的影响

**只考虑简单光照模型有：**

* **环境光**模型
* Lambert**漫反射**模型
* **镜面反射**和Phong模型

### 2. 环境光

**特性：**

* 从环境**各个方向投射来的光**
* 没有空间或方向上的特征  
* 均匀地照射在物体的各个表面上
* 等量地向各个方向反射

**模型：**

$$
I_e=I_aK_a
$$

* $I_a$ - 场景中的环境光强度
* $K_a$（反射系数） - 物体表面对环境光的满反射系数

故：物体表面对环境光反射的强度，**仅与$K_a$有关**

### 3. 满反射

**特性：**

* 光源来自于**一个方向**，反射光均匀地射向各个方面。

**模型：**

$$
I-d=I_p*K_d\cos\theta\qquad\sin\in[0,\frac{\pi}{2}
$$

多个光源进行叠加，依次算出来直接求和。

各点反射光强度只与点**光源强度**、**入射角**、**反射系数**、**各面朝向**有关。

### 4. 镜面反射

**特性：**

* 镜面反射遵循反射定律

越光滑，反射光线越汇集，可观察区域就越窄。

**模型 - Phong模型：**

$$
I_s = I_pK_S\cos^n\alpha
$$

* $\alpha$ - 与理想反射角的夹角
* $n$ - 镜面高光系数，与光滑程度有关。

若反射角$R$、观察着$V$为规格化单位矢量，则：

$$
I_s=I_pK_S(R\cdot V)^n
$$

### 5. 表面光强计算

$$
I=I_e+I_d+I_s=I_aK_a+I_l[K_d(L\cdot N)+K_S(V\cdot R)^n]
$$

* 第一项 - 泛光
* 第二项 - 漫反射光分量
* 第三项 - 镜面高光分量

### 6. 光强衰减

光照模型需要考虑光强衰减，否则不真实。

方式：

* 常数衰减
* 一次函数衰减
* **二次函数衰减**：$f(d)=\min(1,\frac{1}{c_0+c_1d+c_2d^2})$

**考虑衰减的多光源光强计算：**

$$
$$

### 7. 颜色

颜色模型：

* 面向硬件：RGB、CYM等
* 面向视觉感知：HSI。

考虑彩色后，计算时即分成三个颜色分量计算。

## 三、面的光照处理

基于简单光照模型的多边形绘制。  
需要进行明暗处理。

### 1. 恒定光强

只用一种颜色绘制多边形：

1. 取多边形任意一点，利用光照模型计算颜色
2. 用这个颜色填充整个多边形

适用场合：

* 光源无穷远处：$L\cdot N$为常数
* 视点无穷远处：$V\cdot R$为常数
* 多边形是景物表面的精确表示

优点：速度快

**缺点：**

* 相邻多边形颜色过渡不光滑
* 用多边形网格来逼近和表示曲面时，曲面光照效果呈现不连续的光亮度跳跃变化，马赫带效应。

解决方法：

* 用尽量小的多边形来毕竟曲面
* 光滑着色

### 2. Gouraud明暗处理

对于一顶点$V$：

1. 用相邻平面法向量的平均值，作为该点法向量。
2. 利用光照模型，计算顶点的光强度
3. 利用插值，计算交界处的光强度。

## 四、透明度

## 五、阴影

* 完全阴影
* 半阴影

经过两次渲染可实现阴影。

## 六、材质纹理

物体表面细节，对于恒定反射系数，不能很好体现，  
除非把各点反射系数设为不一样，才能通过亮暗的区别表现纹理，  
但也可以通过纹理简单实现。

纹理模拟物体表面细节。  
用二维纹理图象贴到多边形表面上。

**分类：**

* 二维纹理
* 三维纹理

**表现形式：**

* 颜色纹理
* 几何纹理：基于景物表面微观几何形状的表面纹理
* 过程纹理：用规则或过程藐视动态变化的自然景象（如正在播放视频的电视）

**纹理图像定义：**

若单色，采用二维数组，01表示颜色。  
多色则采用三维数组。

**二维纹理映射的基本原理：**

纹理空间↔物体空间↔像素空间
