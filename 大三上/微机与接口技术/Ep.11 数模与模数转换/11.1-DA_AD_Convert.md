# Ep.11 数模与模数转换

在工业控制当中，传感器收集的物理信号量（温度、压力等）为“物理信号”，需要转换为电信号（数字量或模拟量）。

传感器通过变迭器和放大滤波，将其转换为模拟量，为**时间和数字**上连续的量，  
通过多路转换与采样（隔一定时间采样，转换为离散的数据）保持，再通过A/D转换，则转换为数字量，可供微型计算机读取。  
该过程为“输入通道”。

同时存在“输出通道”，由微型计算机通过输出接口，进行D/A转换，经过放大驱动，送到工业上的执行机构。

整个过程均需要“物理量变换”、“信号处理”和“信号变换”，  
其中**AD转换**则属于信号变换。

## 一、数模(D/A)转换

### 1. D/A转换器的工作原理

组成：

* 运算放大器
* 模拟开关
* 电阻网络

**运算放大器**组成一个求和器，用来求各支路电流的和。  
故利用可利用**电阻网络**和**模拟开关**，将数字量的各位`0`和`1`乘上权重，再进行求和，以转换为模拟量。

电阻网络的类型：

* $n=8$的加权电阻网络  
  用$R=2^n(1\le n \le 8)$的电阻组成电阻网络，从而对应数字量各位位权；  
  模拟开关决定接通或断开，从而对应数字量各位二进制数。
* R-2R的梯形电阻网络  
  第一个支路分流为$\frac{1}{2}I$，之后每一个支路通过上一个并联的电阻，又分流上一个支路的$\frac{1}{2}I$，  
  故第$i$个支路电流为$\frac{1}{2^i}I$，从而对应位权。
  
### 2. D/A转换器的主要技术指标

* 分辨率  
  输入的二进制数每$\pm1$个最低有效位(LSB)使输出变化的程度。  
  表示方法：
  * 用多少位表示，如如4位
  * 用LSB表示

### 3. D/A转换芯片 - DAC0832

#### (1) 特点

* 8位电流输出型
* T型电阻网络

#### (2) 主要引脚功能

* 用于数据锁存器
  以下三个信号全部有效，才能把数字量输入送入数据锁存器
  * $\overline{WR_1}$ - 写数据锁存器
  * $\overline{CS}$ - 片选信号
  * $ILE$ - 允许输入锁存信号  
* 用于DAC寄存器  
  以下两个信号全部有效，才能把数据锁存器数据送入DAC寄存器。
  * $\overline{WR_2}$ - 写DAC寄存器
  * $\overline{XFER}$ - 传送控制信号  
    允许输入锁存器的数据传送到DAC寄存器（类似于$\overline{CS}$）。
* 其他引脚
  * $DI_7 \sim DI_0$ - 数据线  
    用于输入数字量。
  * $V_{REF}$ - 参考点  
    范围有$-10V\sim +10V$、一般为$-5V\sim +5V$
  * $I_{OUT1}$/$I_{OUT2}$ - 输出模拟电流

#### (3) 模拟输出

* 单极性电压输出
* 双极性电压输出

#### (4) 工作模式

* 直通模式  
  数据一旦加在数据线$DI_7\sim DI_0$上，DAC0832的输出就立即响应。  
  一般在无CPU的情况下经常使用。
* 单缓冲模式  
  使输入锁存器或DAC寄存器二者之一处于直通，即芯片只占用一个端口地址。  
  该模式下，输入数据**只经过一级**数据缓冲器送入D/A转换器，**只需要执行一次写操作**。
  
  基本模式：

  ```asm
  MOV AL, DATA ; 取数据
  MOV DX, PORT ; 取写入端口
  OUR DX, AL   ; 执行一次写操作
  ```

  实现方式：

  * 把$\overline{WR_1}$、$\overline{CS}$接地，$ILE$接高电平，则为第一级数据缓冲器直通，  
    数据由$\overline{WR_2}$、$\overline{XFER}$控制写入第二级数据缓冲器，从而进行转换。
  * 把$\overline{WR_2}$、$\overline{XFER}$接地，则为第二级数据缓冲器直通，  
    数据由$CS$、$\overline{WR_1}$、$\overline{CS}$控制写入第一级数据缓冲器，从而进行转换。

* 双缓冲模式  
  对输入寄存器和DAC寄存器均需控制，此时芯片占用两个端口地址。  
  该模式下，输入数据先要写入输入锁存器，再将数据寄存器的内容写入DAC寄存器。

  基本模式：

  ```asm
  MOV AL, DATA  ; 取数据
  MOV DX, PORT1 ; 取输入锁存器端口地址
  OUT DX, AL    ; 数据送入输入锁存器
  MOV DX, PORT2 ; 取DAC寄存器端口地址
  OUT DX, AL    ; 数据送入DAC寄存器
  ```

## 二、模数(A/D)转换

### 1. A/D转换器的工作原理

是把模拟量转换为数字量的线性电子器件，将输入的模拟电压或电流转换为二进制数字量，便于微机处理。

**过程：**

* 采样保持 - 将时间上连续变化的量，采样为等距的脉冲。
  * 采样定理（奈奎斯特定理）：采样频率大于信号最高频率的2倍，则保留完整信息。
* 量化 - 以一定的量化阶距为单位，把树枝上连续的模拟量转换为数值上的离散量。  
  会存在舍入，导致**量化误差**。
* 编码 - 变成计算机可以识别的二进制。

**A/D转换器类型：**

* 计数型A/D转换器
* 双积分型A/D转换器
* 逐位反馈型A/D转换器

**逐次逼近型ADC原理：**

类似天平称重的方法，逐步用砝码的累计重量去逼近。  
而在搜索的过程中，可以采用二分搜索法，  
采用若干$2^n$个砝码，依次加上，重了就去掉，直至逼近。

### 2. A/D转换器的主要技术指标

* 分辨率：说明A/D转换器对输入信号的分辨能力  
  一般用输出二进制的位数表示。
* 绝对量化误差  
  设分辨率为$n$位，量程为$V$，则绝对量化误差为$\frac{V}{2^{n+1}}$
* 相对量化误差
* 转换时间：从转换控制信号到来开始，到输出端得到稳定的数字信号所经过的时间。  

### 3. A/D转换器的应用 - ADC0809

#### (1) ADC0809特点

* 8通道输入
* 8位字长
* 逐位逼近型
* 转换时间$100\mu\mathrm{s}$
* 内置三态输出缓冲器（可直接与CPU相连）

#### (2) ADC0809主要引脚功能

* $D_7\sim D_0$ - 数字量输出  
  三态
* $IN_7\sim IN_0$ - 8通道模拟量输入
* $ADD_C$、$ADD_B$、$ADD_A$ - 8路模拟电压输入选择端/通道地址
* $ALE$ - 通道地址锁存  
  `1`时接通、`0`时锁存某路的模拟信号。
* $START$ - 启动转换信号  
  宽度$200\mathrm{ns}$，上升沿复位SAR，下降沿启动转换。
* $EOC$ - 转换结束状态输出  
  上升沿有效
* $OE$ - CPU允许输出端  
  打开输出三态门

#### (3) ADC0809工作过程

* 送通道地址，以选择要转换的模拟输入
* 锁存通道地址到内部地址锁存器
* 启动A/D变换
* 判断是否转换结束
* 读取输出结果

#### (4) A/D转换器与系统连接考虑

1. 输入模拟电压的连接
2. 数据输出线和系统总线的连接
   * ADC0809因为有三态输出门，输出端可以直接和系统总线相连
   * 部分芯片无三态门或不受信号控制（结束后自动接通），需要在总线间加个三态门组建
3. 启动信号
4. 判断结束
   * 软件延时等待  
     需要预先知道完成一次A/D转换的时间，然后定略大的延时如$120\mu \mathrm{s}$，程序执行完时，转换也完成，  
     此时不用EOC信号，CPU效率很低，因为要占线忙等待转换结束。

     ```asm
     OUT DX, AL
     CALL DELAY
     IN DX, AL
     ```

   * 查询
     隔段时间查询EOC信号，不用占线忙等待，但查询占用资源效率仍低。

     ```asm
     OUT DX, AL
     WAIT0: IN AL, DX
            AND AL, 01H
            JNZ WAIT0 ; EOC为低，才开始转换
     WAIT1: IN AL, DX
            AND AL, 01H
            JZ WAIT 1 ; EOC为高，转换结束
     FINISH: IN AL, DX ; 读数据
     ```

   * 中断  
     接到中断控制器的IN端，在中断服务程序读入转换结果。