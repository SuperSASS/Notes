# Ep.4 数据链路层

## 一、基本概念

数据链路层的功能：确保数据在链路上的可靠传输。

涉及的问题：

* 流量控制
* 帧格式
* 差错控制
* 链路管理
* 信道共享

在Internet网体系结构的第二层，与物理结构相关。

### 2. 实现

* 一般由网络适配器实现
* 网卡：Ethernet卡、X.25网卡
* 网卡组成
  * RAM
  * DSP芯片
  * 主机总线接口
  * 网络接口

### 3. 服务

* 无应答无连接  
  错误恢复由高层负责
* 有应答无连接  
  通过应答改善可靠性
* 有应答面向连接  
  过程：连接建立、分组数据传输、释放连接

## 二、组帧

组帧指将**比特流分段**，封装成数据帧。

**目的：**将数据按块进行错误检测/控制。  
分块的原因：错误时重传代价小。

> 一个网络比特流组帧的示例：
>
> * 同步序列
> * 标志 - 同步结束、数据开始
> * 以太帧头
> * IP报头
> * TCP报头
> * 数据

方法：

* Timing - 定时
* 字节计数  
  如`5ABCDE2KK3FFF`，数字代表字节数，对应后面若干个字节。  
  如果表示字节数的数字错传，则会导致错误。
* 字符填充
  * 用`DLE STX`（数据头）和`DLE ETX`（数据尾）字符标志进行定界
  * 若需要传送`DLE`本身，则在之前插入`DLE`进行转义
* 比特填充  
  传送时：连续的5个`1`后面插入`0`；接收时则若连续5个`1`后有`0`则删除。

## 三、错误控制

**目的**：避免数据丢失或者损坏。

**方式**：  
发送方在报文中插入错误检测为，接收方根据这些检测为进行错误检测。  
如果正确，则接收并应答`ACK`；否则丢弃或应答`NAK`。

**控制方法**：

* 重传：如果收到`NAK`，或在规定时间内没有应答，则需要重传。
* 错误纠正：发送方在报文中插入错误纠正码，接收方根据纠错码进行错误纠正。  
  利用EDC进行检错甚至纠错。EDC越长性能越好，但开销越大。

**纠错方法**：

* 硬件冗余检测

## 四、流量控制

寻求最大吞吐率，并且快的发送方不会将慢的接收方淹没（速率匹配）。  
发送方节流直到接收方同意。

### 1. 停止等待协议

#### (1) 简单停止等待协议

缓冲区：因为速率不匹配，所以必须设立发送和接收缓冲区。

在研究该协议时，先作两个前提假设：

* 链路理想：数据不会出错丢失。
* 速率理想：接收方总能及时的接收发送来的数据，且能及时向主机上报。  
  相当于缓冲区容量无限大，且接收发送速率精确相等。

此时不需要任何流量控制，传输也可以不出差错的进行。

此时去掉假设二，需要进行简单的流量控制，即停止等待协议。  
**原理是**：当接收方接收到数据，向主机发送完成然后应答，接收方接收应答再发送。

#### (2) 考虑帧出错的停止等待协议

去掉假设一，会发生帧丢失现象。

如果帧出错，则接收方发送`NAK`，发送方重发。

可能是传送过来的帧丢失，则接收方不会发送应答帧，若不处理接收发发生死锁，  
也可能是应答帧丢失。

规定一个超时时间，超过这个时间没接收到应答帧则重发。

但如果是应答帧丢失，重发时接收方会接收到同样的数据帧，  
此时可以给每个帧增加一个序号，相同的帧序号相同，用以区分。

#### (3) 特点

### 2. 连续ARQ协议

发送完一个数据帧后，不是等待`ACK`再继续发送，而是一直发送。  
当应答超时（规定出错时不做响应，而非发送`NCK`，这样更简单统一）时，则回退到需要重发的位置进行重发。  

能最大程度利用吞吐率，但传送效率降低，  
当误码率很大的时候，方法不好。

## 五、信道利用率和最佳帧长度

由于每个数据帧都包含一定的控制信息，  
即使连续不停地发送数据真，信道的利用率也不能达到$100\%$。

存在一个最佳帧长度，一般都在`1K~2K`之间。

## 六、链路层协议

* 局域网LAN：Ethernet
* 广域网WAN：**HDLC**
* 因特网Internet：SLIP, **PPP**

### 1. HDLC

站点类型：

* 主站 - Primary station
  * 控制链路，维护连接从站的逻辑链路
  * 发送的帧叫：命令帧
* 从站 - Secondary station
  * 受主站控制
  * 发送的帧叫：响应帧
* 混合站 - Combined station

结构：

* 非平衡点到点


传输模式：

* 正常响应模式
  * 非平衡结构
  * 主站发起与从站的传输
  * 从站只能通过对主站命令的应答来传输数据
  * 点对点
* 异步平衡模式
* 异步响应模式
  * 非平衡

**帧结构：**

* Flags Field - 标志域
  * 作用：帧定界
* Address - 地址域
  * 作用：指明发送或接收帧的从站
  * 一般用8bit长度，可扩展到多个字节  
    每个8bit组的第1个bit指明是否扩展，若为`0`则之后8bit仍为地址域，为`1`则是最后一个字节。
  * 全`0`为无效地址，全`1`为广播地址。
* 控制域
  * 作用：区分不用的帧类型
    * 信息帧(I) - 传输给用户的数据
    * 监控帧(S) - 不是用捎带应答的ARQ
    * 无编号帧(U) - 辅助链路控制  
      5个bit作为命令
* 帧校验和

操作：

* 初始化  
  任何一方都可以通过六个置位符号初始化
* 

### 2. Internet数据链路层

采用：  

* 点到点链路
* 拨号主机-路由器连接(SLIP)  
  简单、但需要预先了解对方的IP，目前已很少使用。
* 路由器-路由器租用线路(**PPP**)  
  * 标志域 - `01111110`
  * 地址域 - `00000000`，因为点到点，地址域无意义
  * 控制域
  * 协议域
    * `0021`
    * `C021`
    * `8021`